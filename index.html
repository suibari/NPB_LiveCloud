<!doctype html>
<html lang="ja">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@suibari_cha">
    <meta property="og:url" content="https://npb-livecloud.herokuapp.com/">
    <meta property="og:title" content="NPB-LiveCloud!(ライブクラウド)">
    <meta property="og:description" content="NPB-LiveCloud! は、プロ野球応援Webアプリです。アカウント登録不要！　Twitterの野球関連ツイートを集計してワードクラウド表示します。どのチームでいまどういう話題がホットなのか、グラフィカルに知ることができます！">
    <meta property="og:image" content="https://user-images.githubusercontent.com/61776220/90979167-5147d400-e58e-11ea-89f7-67eef521e05d.png">
    <link rel="shortcut icon" href="./client/favicon.ico"/>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <title>NPB Live-cloud!</title>
    <style type="text/css">
      div.TPS { /* 小画面用 */
        text-align:left;
        padding: 0;
        padding-left: 5px;
        border: 0 none;
        border-left-width: 5px;
        border-left-style: solid;
      }
      @media only screen and (min-width:651px) { /* 中画面用 */
        div.TPS {
          padding-left: 15px;
          border-left-width: 8px;
        }
      }
      div.TPS.baystars  {border-color: dodgerblue;}
      div.TPS.giants    {border-color: orange;}
      div.TPS.tigers    {border-color: yellow;}
      div.TPS.swallows  {border-color: limegreen;}
      div.TPS.dragons   {border-color: darkblue;}
      div.TPS.carp      {border-color: red;}
      div.TPS.hawks     {border-color: gold;}
      div.TPS.lions     {border-color: aqua;}
      div.TPS.buffaloes {border-color: darkgoldenrod;}
      div.TPS.eagles    {border-color: firebrick;}
      div.TPS.fighters  {border-color: steelblue;}
      div.TPS.marines   {border-color: black;}
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-2 btn btn-dark rounded-0 giants TPS">-.--</div>
        <div class="col-2 btn btn-dark rounded-0 baystars TPS">-.--</div>
        <div class="col-2 btn btn-dark rounded-0 tigers TPS">-.--</div>
        <div class="col-2 btn btn-dark rounded-0 carp TPS">-.--</div>
        <div class="col-2 btn btn-dark rounded-0 dragons TPS">-.--</div>
        <div class="col-2 btn btn-dark rounded-0 swallows TPS">-.--</div>
      </div>
      <div class="row">
        <div class="col-2 btn btn-dark rounded-0 lions TPS">-.--</div>
        <div class="col-2 btn btn-dark rounded-0 hawks TPS">-.--</div>
        <div class="col-2 btn btn-dark rounded-0 eagles TPS">-.--</div>
        <div class="col-2 btn btn-dark rounded-0 marines TPS">-.--</div>
        <div class="col-2 btn btn-dark rounded-0 fighters TPS">-.--</div>
        <div class="col-2 btn btn-dark rounded-0 buffaloes TPS">-.--</div>
      </div>
    </div>
    <div class="container-fluid pt-3">
      <div class="raw no-gutters">
        <figure>
          <div class="col px-0">
            <div class="chartcontainer" id="chart">
              <!-- svg -->
            </div>
          </div>
        </figure>
      </div>
    </div>
    <!-- footer -->
    <div class="container-fluid">
      <div class="raw text-center small text-muted my-2">
        <a href="" class="text-muted" data-toggle="modal" data-target="#howtouse">つかいかた</a>
      </div>
      <div class="raw text-center small text-muted my-2">
        NPB-LiveCloud! 
        <a href="https://github.com/suibari" class="text-muted">@suibari</a>
      </div>
    </div>
    <!-- modal -->
    <div class="modal fade" id="howtouse" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">つかいかた</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="container-fluid">
              <div class="raw　no-gutters">
                <ul>
                  <li>文字の大きさは、そのワードのツイート総数です。</li>
                  <li>文字の色は、球団カラーに対応しています。</li>
                  <li>画面上部の数値は、各球団の盛り上がり度(現在)です。</li>
                  <li>表示は10秒毎に自動更新されます。</li>
                  <li>毎日AM1:00～7:00はメンテナンス時間です。</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Optional JavaScript -->
    <script src="./client/wordCloud.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.5/d3.layout.cloud.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
    <script>
      let myWordCloud = new wordCloud('#chart'); // #chartにワードクラウドインスタンス生成
      const socket    = io.connect();
      let myTeam      = "all";                   // ワードクラウド表示チーム。req_updateを出すときに使う

      // updateのリクエストを送信
      socket.emit('req_update', myTeam); // ブラウザ立ち上げ時
      setInterval(() => {                      // 一定時間ごと
        socket.emit('req_update', myTeam);
      }, 10000)

      // update_countイベントを受信したら、ワードクラウドを更新する
      socket.on('update_count', (count) => {
        console.log('YUKI.N > received count:' + count.length);
        // ワードクラウド更新
        myWordCloud.update(count);
      })
      // update_tpsイベントを受信したら、TPSを更新する
      socket.on('update_tps', (tps) => {
        console.log('YUKI.N > received tps, teams: ' + Object.keys(tps).length);
        // TPS更新
        for (let team in tps) {
          $('.TPS.'+ team).text(tps[team]);
        }
      })

      // TPS要素へのクリックイベント設定
      const teams = [
        "baystars", "giants", "tigers", "swallows", "dragons", "carp", 
        "hawks", "lions", "buffaloes", "eagles", "fighters", "marines"
      ];
      teams.forEach((team) => {
        $('.TPS.'+team).on('click', () => {
          let selectTeam;

          // 選択中のチームと選択したチームが同じならallを設定
          if (myTeam == team) {
            myTeam = "all"; // チームリセット
          } else {
            myTeam = team;  // 選択チームをmyTeamにセット
          }

          console.log("YUKI.N > select team: " + myTeam);
          socket.emit('req_change_room', myTeam);
          socket.emit('req_update', myTeam);
        })
      })
    </script>
  </body>
</html>